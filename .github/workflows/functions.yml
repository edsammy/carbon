name: Deploy Self-Hosted Functions

on:
  push:
    branches: [main]
    paths: ["packages/database/supabase/functions/**"]
  workflow_dispatch:

jobs:
  functions:
    name: Deploy Self-Hosted Functions
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment:
          - name: "govcloud"
            instance_host: GOVCLOUD_INSTANCE_HOST
            instance_ssh_key: GOVCLOUD_INSTANCE_SSH_KEY

    env:
      INSTANCE_HOST: ${{ secrets[matrix.environment.instance_host] }}
      INSTANCE_SSH_KEY: ${{ secrets[matrix.environment.instance_ssh_key] }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "$INSTANCE_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $INSTANCE_HOST >> ~/.ssh/known_hosts

      - name: Deploy functions
        run: |
          ssh ubuntu@$INSTANCE_HOST 'sudo bash -c "cd /home/ubuntu/supabase && git config pull.rebase true && sudo bash sync-carbon-functions.sh"'

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/id_rsa
